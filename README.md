npm2nix
=======
Deploy [Node.js Package Manager](http://www.npmjs.org) (NPM) packages with the
[Nix package manager](http://www.nixos.org/nix)!

Installation
============
There are two ways this package can installed.

To install this package through the Nix package manager, obtain a copy of
[Nixpkgs](http://nixos.org/nixpkgs) and run:

    $ nix-env -f '<nixpkgs>' -iA nodePackages.npm2nix

Alternatively, this package can also be installed through NPM by running:

    $ npm install -g npm2nix

Usage
=====
`npm2nix` can be used for a variety of use cases.

Deploying a Node.js development project
---------------------------------------
The primary use case of `npm2nix` is to deploy a development project as a NPM
package.

What Node.js developers typically do in a development setting is opening the
source code folder and running:

    $ npm install

The above command-line instruction deploys all dependencies declared in the
[`package.json`](https://www.npmjs.org/doc/files/package.json.html) configuration
file so that the application can be run.

With `npm2nix` you can use the Nix package manager for exactly the same purpose.
Running the following command generates a collection of Nix expressions from
`package.json`:

    $ npm2nix

The above command generates three files `registry.nix` containing Nix expressions
for all package dependencies and the packge itself, `node-env.nix` contains the
build logic and `default.nix` is a composition expression allowing users to
deploy the package.

By running the following Nix command with these expressions, the project can be
built:

    $ nix-build -A build

The above instruction places a `result` symlink in the current working dir
pointing to the build result. An executable part of the project can be run as
follows:

    $ ./result/bin/npm2nix

Generating a tarball from a Node.js development project
-------------------------------------------------------
The expressions that are generated by `npm2nix` (shown earlier) can also be used
to generate a tarball from the project:

    $ nix-build -A tarball

The above command-line instruction produces a tarball that can is placed in the
following location:

    $ ls result/tarballs/npm2nix-6.0.0.tgz

The above tarball can be distributed to others and installed with NPM by running:

    $ npm install npm2nix-6.0.0.tgz

Deploying a development environment of a Node.js development project
--------------------------------------------------------------------
Besides deploying a development project, it may also be useful to only install
the project's dependencies and spawning a shell session in which they can be
found.

The following command-line instruction uses the earlier generated expressions
to deploy all the dependencies and opens a development environment:

    $ nix-shell -A build

Within this shell session, files can be modified and run without any hassle.
For example, the following command should work without any trouble:

    $ node bin/npm2nix.js --help

Deploying a collection of NPM packages from the NPM registry
------------------------------------------------------------
The secondary use of `npm2nix` is deploying existing NPM packages from the NPM
registry.

Deployment of packages from the registry is driven by a JSON specification that
looks as follows:

    [
      "async",
      "underscore",
      "slasp",
      { "mocha" : "1.21.x" },
      { "mocha" : "1.20.x" },
      { "nijs": "0.0.18" },
      { "npm2nix": "git://github.com/NixOS/npm2nix.git" }
    ]

The above specification is basically an array of objects. For each element that
is a string, the `latest` version is obtained from the registry.

To obtain a specific version of a package, an object must defined in which the
keys are the name of the packages and the values the versions that must be
obtained.

Any version specification that NPM supports can be used, such as version numbers,
version ranges, HTTP(S) URLs, Git URLs, and GitHub identifiers.

Nix expressions can be generated from this JSON specification as follows:

    $ npm2nix -i node-packages.json

And by using the generated Nix expressions, we can install NiJS through Nix as
follows:
    
    $ nix-env -f default.nix -iA nijs

For every package for which the latest version has been requested, we can
directly refer to the name of the package to deploy it.

For packages for which a specific version has been specified, we must refer to
it using an attribute that name that is composed of its name and version
specifier.

The following command can be used to deploy the first specific version of `mocha`
declared in the JSON configuration:

    $ nix-env -f default.nix -iA '"mocha-1.21.x"'

`npm2nix` can be referenced as follows:

    $ nix-env -f default.nix -iA '"npm2nix-git://github.com/NixOS/npm2nix.git"'

Since every NPM package resolves to a package name and version number we can also
deploy any package by using an attribute consisting of its name and resolved
version number.

This command deploys NiJS version 0.0.18:
    
    $ nix-env -f default.nix -iA '"nijs-0.0.18"'

The above command also works with dependencies of any package that are not
declared in the JSON configuration file, e.g.:

    $ nix-env -f default.nix -iA '"slasp-0.0.4"'

Advanced options
================
`npm2nix` also has a number of advanced options.

Development mode
----------------
By default, NPM packages are deployed in production mode, meaning that the
development dependencies are not installed by default. By adding the
`--development` command line option, you can also deploy the development
dependencies:

    $ npm2nix --development

Specifying paths
----------------
If no options are specified, `npm2nix` makes implicit assumptions on the
filenames of the input JSON specification and the output Nix expressions. These
filenames can be modified with command-line options:

    $ npm2nix --input package.json --output registry.nix --composition default.nix --node-env node-env.nix

Linking dependencies
--------------------
All package dependencies are copied by default into the Nix package. However, to
reduce disk space they can also be symlinked by adding the following setting.

    $ npm2nix --link-dependencies

Please keep in mind that symlinking does not always work. For example, in
situations in which a dependency tries to refer to a dependency of a parent,
problems may occur, because CommonJS always search relative to its own resolved
path. Therefore, this option is not enabled by default.

Using alternative NPM registries
--------------------------------
You can also use an alternative NPM registry (such as a private one), by adding
the `--registry` option:

    $ npm2nix -i node-packages.json --registry http://private.registry.local

API documentation
=================
This package includes API documentation, which can be generated with
[JSDuck](https://github.com/senchalabs/jsduck). The Makefile in this package
contains a `duck` target to generate it and produces the HTML files in `build/`:

    $ make duck

License
=======
The contents of this package is available under the [MIT license](http://opensource.org/licenses/MIT)
